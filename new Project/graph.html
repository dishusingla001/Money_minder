<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="graph.css">
  <script src="https://kit.fontawesome.com/d077a0e0a8.js" crossorigin="anonymous"></script>

</head>
<body>
      <div class="header-body">
        <div class="logo-info">
            <img src="logo-moneyminder.png" alt="Logo">
        
            <div id="logo-title">
                <h1>Money</h1>
                <br>
                <h1>Minder</h1>
            </div>               
            
        </div>

        <div class="nav-bar">
            <nav>
                <div class="toggle">
                    <div class="icon"> <i class="fa-solid fa-bars"></i></div>
                </div> 

                <ul class="nav-bar-list">
                    <li><a href="Home.html">Home</a></li>
                    <li><a href="expenses.html">Expenses</a></li>
                    <li><a href="">Budget</a></li>
                    <li><a href="">Expenditure</a></li>
                    <li><a href="help.html">Help</a></li>
                </ul>
            </nav>
        </div>

        <div class="login-button" id="auth-button">
          Login
          <!-- Filled dynamically -->
      </div>


    </div>

    <div class="header">
      <div class="dashboard-title">Financial Dashboard</div>
      <div class="user-info">Welcome back, John Doe</div>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-title">Total Spent (All Time)</div>
        <div class="stat-value" id="allTimeSpent">$0.00</div>
        <div class="stat-change">Lifetime spending</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-title">Last Entry</div>
      <div class="stat-value">1500</div>
      <div class="stat-change">Date</div>
    </div>
    
  </div>

  <div class="chart-section">
    <div class="tab-container">
      <div class="tab active">Monthly Reports</div>
    </div>
  
    <div id="monthlyChartSection">
      <div class="chart-header">
        <div class="chart-title">Daily Spending Overview</div>
      </div>
      <div class="chart-container">
        <canvas id="monthlySpendingChart"></canvas>
      </div>
    </div>
  </div>
  

<!-- <script>
  document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const loginBtnDiv = document.getElementById('auth-button');

    if (isLoggedIn) {
      const email = localStorage.getItem('userEmail') || 'User';
      loginBtnDiv.innerHTML = `<a href="#" onclick="logout()">Logout</a>`;
    } else {
      loginBtnDiv.innerHTML = `<a href="login.html">Login</a>`;
    }

    // Block direct access to dashboard if not logged in
    if (!isLoggedIn) {
      alert('You must be logged in to view the dashboard.');
      window.location.href = 'login.html';
    }

    // Protect expenses link
    const expensesLink = document.querySelector('a[href="expenses.html"]');
    if (expensesLink) {
      expensesLink.addEventListener('click', function (e) {
        if (!isLoggedIn) {
          e.preventDefault();
          alert("You must be logged in to access expenses.");
          window.location.href = "login.html";
        }
      });
    }
  });

  function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userEmail');
    window.location.href = 'Home.html';
  }
</script> -->


<script>
 
  // Fetch stats from backend and update the stats container
// Fetch stats from backend using userEmail
const userEmail = localStorage.getItem('userEmail');

fetch(`/api/stats?userEmail=${encodeURIComponent(userEmail)}`)
  .then(res => res.json())
  .then(data => {
    document.querySelector('.stat-value').textContent = `$${data.totalSpent}`;
    document.querySelector('.stat-change').textContent = `$${data.remaining} remaining`;
    document.querySelectorAll('.stat-value')[1].textContent = `${data.percentUsed}%`;
  })
  .catch(err => {
    console.error("Failed to load stats:", err);
  });


// ðŸ‘‡ Fetch all-time spent from backend
fetch(`/api/total-spent?userEmail=${encodeURIComponent(userEmail)}`)
  .then(res => res.json())
  .then(data => {
    document.getElementById('allTimeSpent').textContent = `$${data.totalSpent}`;
  })
  .catch(err => {
    console.error("Error loading all-time spending:", err);
  });



// Get all stat cards
const statCards = document.querySelectorAll('.stat-card');

statCards.forEach(card => {
  const title = card.querySelector('.stat-title');
  if (title && title.textContent.includes('Last Entry')) {
    fetch(`/api/last-expense?userEmail=${encodeURIComponent(userEmail)}`)
      .then(res => res.json())
      .then(data => {
        const valueElem = card.querySelector('.stat-value');
        const dateElem = card.querySelector('.stat-change');
        valueElem.textContent = `$${data.amount}`;
        dateElem.textContent = data.date;
      })
      .catch(err => {
        console.error("Error loading last expense entry:", err);
      });
  }
});


fetch(`/api/last-6-days?userEmail=${encodeURIComponent(userEmail)}`)
  .then(res => res.json())
  .then(data => {
    const labels = data.map(entry => entry.day);
    const values = data.map(entry => parseFloat(entry.total));

    const ctx = document.getElementById('last6DaysChart').getContext('2d');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Daily Spending',
          data: values,
          backgroundColor: '#3a86ff',
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: '#aaa',
              callback: value => '$' + value
            },
            grid: {
              color: 'rgba(255,255,255,0.1)'
            }
          },
          x: {
            ticks: {
              color: '#aaa'
            },
            grid: {
              color: 'rgba(255,255,255,0.1)'
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: context => `$${context.raw.toFixed(2)}`
            }
          }
        }
      }
    });
  })
  .catch(err => {
    console.error("Failed to load last 6 days data:", err);
  });

</script>


</body>
</html>